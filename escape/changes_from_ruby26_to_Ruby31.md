---
title: Ruby2.6からRuby3.1までの一般Ruby使いの業務に影響がありそうな変更点まとめ
date: 2021-12-25
tags: ["Ruby"]
---

2021年のクリスマスが終わりました。今回でRuby3.1がリリースされましたが、弊社の業務で使用しているRubyのバージョンアップが滞ってしまっています。皆様の中にもキーワード引数の分離という変更点が入ったRuby3.0に上げるところで足踏みをしているところがあるのではないでしょうか？

この記事は主に自分のためというか弊社の社内向けに残しておきたいものとなっています。バージョンアップをするために直しておく必要のあるコードは何か、バージョンアップして便利になるところは何か、非推奨になるなど気をつける部分は何かetc...

ちょっと便利になるとか省略記法とか特定の褒められない書き方のコードにのみ影響があるような話は割愛し、勉強熱心ではないRuby使いの方々にも影響のある部分だけに絞って、できるだけ少ない労力でバージョンアップのための予備知識をつけられるような内容を目指します。

内容的には[クックパッド開発者ブログ](https://techlife.cookpad.com)の「プロと読み解く Ruby ○.○ NEWS」の内容のうち、絶対に必要な部分だけピックアップしていく形になっています。各バージョン間ごとに該当記事を貼っておきますので、詳細を知りたい方はそちらをご覧ください。

前提として2.6までの機能は把握している想定で進めます。

# 2.6

2.6.0 ~ 2.6.9まででの変更点は、2.6.3系で「令和」のサポートが追加された点です。Rubyを業務で使っていく上で影響的に大した話ではないので、ここでの説明を持って終わりにします。

# 2.6 -> 2.7

詳細な変更点を知りたい場合はこちらをご覧ください

https://techlife.cookpad.com/entry/2019/12/25/121834

## 便利になる点

### パターンマッチの追加

2.7からの新機能です。2.7時点では実験的機能ですが、3.0から正式な機能になります。業務での利用は3.0までバージョンアップをしてからの方がよいでしょう。

文法は `case ... in`です。
```ruby
case [1, 2, 3]
in [a, *other]
  p a           # 1
  p other       # [2, 3]
end
```

`in`で示されるいずれのパターンにもマッチしない場合`NoMatchingPatternError`が発生しますが、3.0で`true`/`false`に変更されます。

### `Enumerable#tally`の追加

要素の数を数える便利メソッドです。

```ruby
["A", "B", "C", "B", "A"].tally
#=> {"A"=>2, "B"=>2, "C"=>1}
```

### `Symbol#start_with?`、`Symbol#end_with?`の追加

`String#start_with?`や`String#end_with?`が登場して便利に使っているので、皆様もそうであろうという前提のもと紹介しますが、`Symbol`でも同じことができるようになります。

### 始端なしRange

2.6に終端なしRangeが書けるようになりましたが、同じように始端なしRangeが2.7から書けるようになります。

```ruby
%w[A B C D E F G][..2] #=> ["A", "B", "C"] 
```

ただし、気をつけるべき点があり、`nil..nil`のような範囲オブジェクトの持つ意味が変わります。

https://qiita.com/rhiroe/items/5ef77da3e8767723aad2

value or nil な結果を返すメソッドや変数を使ったRangeを使っている場合は一度確認してみた方が良いでしょう。

## 気をつける点

### キーワード引数分離に向けた警告

3.0からキーワード引数が分離されます。これまでHashを引数に渡した際に、キーと同じキーワード引数があるとよしなに解釈してくれていましたが、これがHashの引数とキーワード引数を明確に分離して解釈されるようになります。今回、このキーワード引数の分離によって3.0以降プログラムが壊れる箇所について警告が発生します。
[移行ガイド](https://www.ruby-lang.org/en/news/2019/12/12/separation-of-positional-and-keyword-arguments-in-ruby-3-0/)が用意されていますので、こちらを参考に修正します。

```ruby
def foo(sample:); puts sample; end
foo({ sample: 'hello' })
```

こんな感じのコードはRuby3以降エラーになります。

ちなみにdeprecated警告については2.7.2以降、$VERBOSEモードでしか表示されなくなっていますので、見落とさないように気をつけてください。

# 2.7 -> 3.0

詳細な変更点を知りたい場合はこちらをご覧ください

https://techlife.cookpad.com/entry/2020/12/25/155741

* キーワード引数の分離
* `in`演算子のマッチの成否を`true`/`false`で返すようになる
* Numbered parameter への代入の禁止
* 静的解析基盤の導入
* `Hash#except`の導入
* `Ractor`による並列並行プログラミングのサポート
* 正規表現リテラル、および`Range`オブジェクトが`freeze`される

# 3.0 -> 3.1

詳細な変更点を知りたい場合はこちらをご覧ください

https://techlife.cookpad.com/entry/2021/12/25/220002

